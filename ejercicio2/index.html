<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Devo Code Challenge</title>

    <style type="text/css">
    </style>
</head>

<body>
    <script src="jquery.min.js"></script>
    <script src="Highcharts-6.1.1/code/highcharts.js"></script>
    <script src="Highcharts-6.1.1/code/modules/exporting.js"></script>
    <script src="Highcharts-6.1.1/code/modules/export-data.js"></script>
    <script src="data_processing.js"></script>

    <div id="pie" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>
    <div id="line" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>
    <script type="text/javascript">
        const dateRegex = /[0-9]{4}-[0-9]{2}-[0-9]{2}/;
        const catRegex = /#(cat) ([A-Za-z0-9]+)#/i;
        var filesLoaded = 0;
        var totalData = [];
        var categoryTotals = [];
        var pieData = [];
        var lineSeries = [];


        function normalize_entry(procesadas, entrada) {
            var date;
            var category;
            var value;
            /* Data normalization */
            if ("cat" in entrada) {
                date = entrada.d;
                category = entrada.cat.toUpperCase();
                value = entrada.value;
            } else if ("categ" in entrada) {
                date = new Date(entrada.myDate).getTime();
                category = entrada.categ.toUpperCase();
                value = entrada.val;
            } else if ("raw" in entrada) {
                const raw = entrada.raw;
                date = new Date(dateRegex.exec(raw)[0]).getTime();
                const result = catRegex.exec(raw);
                category = result[1] + ' ' + result[2];
                value = entrada.val;
            }

            const pieDataMatches = pieData.filter(serie => serie.name == category)
            if (pieDataMatches.length >= 1) {
                coincidencia = pieDataMatches[0];
                if (coincidencia.date == date) {
                    coincidencia.value += value;
                }
            } else {
                pieData.push({
                    name: category,
                    y: value
                })
            }

            const lineDataMatches = lineSeries.filter(serie => serie.name == category)
            if (lineDataMatches.length == 1) {
                lineDataMatches[0].data.push({
                    x: new Date(date),
                    y: value,
                })
            } else {
                lineSeries.push({
                    name: category,
                    data: [{
                        x: new Date(date),
                        y: value,
                    }]
                })
            }
        }

        function normalize_series(data) {
            var resultado = data.reduce(normalize_entry, []);
            return resultado;
        }


        function uploadHandler(data) {
            if (!Array.isArray(data)) {
                data = [data]
            }
            totalData = totalData.concat(data);
            filesLoaded += 1;
            console.log("totalData: ", totalData)
            console.log("filesLoaded: ", filesLoaded)
            if (filesLoaded == 3) {
                normalize_series(totalData);
                pieData.sort(function (a, b) {
                    return a - b
                });
                lineSeries = lineSeries.map(function (lineSerie) {
                    console.log("lineSerie: ", lineSerie)
                    lineSerie.data.sort(function (a, b) {
                        return a.x.getTime() - b.x.getTime()
                    })
                    console.log("lineSerie: ", lineSerie)
                    return lineSerie;
                })
                console.log("lineSeries: ", lineSeries)
                console.log("pieData: ", pieData)
                Highcharts.chart('pie', {
                    chart: {
                        type: 'pie'
                    },
                    title: {
                        text: 'Browser market shares in January, 2018'
                    },
                    tooltip: {
                        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                                style: {
                                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                                }
                            }
                        }
                    },
                    series: [{
                        name: 'Brands',
                        colorByPoint: true,
                        data: pieData
                    }]
                });

                Highcharts.chart('line', {

                    title: {
                        text: 'Solar Employment Growth by Sector, 2010-2016'
                    },

                    subtitle: {
                        text: 'Source: thesolarfoundation.com'
                    },
                    yAxis: {
                        title: {
                            text: 'Value'
                        }
                    },
                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'middle'
                    },

                    series: lineSeries,

                    responsive: {
                        rules: [{
                            condition: {
                                maxWidth: 500
                            },
                            chartOptions: {
                                legend: {
                                    layout: 'horizontal',
                                    align: 'center',
                                    verticalAlign: 'bottom'
                                }
                            }
                        }]
                    }

                });
            }
        }

        $(document).ready(function () {
            $.ajax({
                dataType: "json",
                url: "data/data1.json",
                mimeType: "application/json",
                success: uploadHandler
            });
            $.ajax({
                dataType: "json",
                url: "data/data2.json",
                mimeType: "application/json",
                success: uploadHandler
            });
            $.ajax({
                dataType: "json",
                url: "data/data3.json",
                mimeType: "application/json",
                success: uploadHandler
            });
        });
    </script>
</body>

</html>